<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Botpress Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <style>
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: slideIn 0.3s ease;
        }

        .code-block {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1d1f21 !important;
            border-radius: 0.5rem;
            margin: 0;
        }

        .inline-code {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        /* Prism theme overrides for better VS Code look */
        pre[class*="language-"] {
            background: #1d1f21 !important;
            margin: 0 !important;
            padding: 1rem !important;
            border-radius: 0.5rem;
            overflow-x: auto;
        }

        code[class*="language-"] {
            background: transparent !important;
            color: #c5c8c6 !important;
            text-shadow: none !important;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .token.comment {
            color: #969896 !important;
            font-style: italic;
        }

        .token.keyword {
            color: #cc6666 !important;
        }

        .token.string {
            color: #b5bd68 !important;
        }

        .token.number {
            color: #de935f !important;
        }

        .token.function {
            color: #81a2be !important;
        }

        .token.class-name {
            color: #f0c674 !important;
        }

        .token.operator {
            color: #8abeb7 !important;
        }

        .token.punctuation {
            color: #c5c8c6 !important;
        }

        .token.property {
            color: #b294bb !important;
        }

        .token.tag {
            color: #cc6666 !important;
        }

        .token.attr-name {
            color: #de935f !important;
        }

        .token.attr-value {
            color: #b5bd68 !important;
        }

        /* Heading styles for **text** formatting */
        h3 {
            font-weight: 600;
            font-size: 1.125rem;
            line-height: 1.4;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .dark h3 {
            color: #f9fafb;
        }

        /* Ensure headings start on new lines */
        h3:first-child {
            margin-top: 0;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            body {
                padding: 0 !important;
            }
            
            .chat-container {
                height: 100vh !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
                margin: 0 !important;
            }
            
            /* Header adjustments */
            .header-mobile {
                padding: 0.75rem 1rem !important;
            }
            
            .header-title {
                font-size: 1rem !important;
            }
            
            .header-subtitle {
                font-size: 0.75rem !important;
            }
            
            /* Status bar */
            .status-mobile {
                padding: 0.5rem 1rem !important;
            }
            
            /* Messages area */
            .messages-mobile {
                padding: 0.75rem !important;
                padding-bottom: 1rem !important;
            }
            
            /* Input area */
            .input-mobile {
                padding: 0.75rem 1rem !important;
                padding-bottom: 1rem !important;
            }
            
            .input-field-mobile {
                width: 100% !important;
                padding: 0.875rem !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
                border-radius: 0.75rem !important;
            }
            
            .send-btn-mobile {
                width: 100% !important;
                padding: 0.875rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
            }
            
            /* Message bubbles */
            .message-bubble-mobile {
                max-width: 95% !important;
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
                line-height: 1.5 !important;
            }
            
            /* Code blocks */
            .code-header-mobile {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
            }
            
            .code-content-mobile {
                padding: 0.75rem !important;
                font-size: 0.8rem !important;
            }
            
            /* Better spacing for mobile */
            .space-y-4 > * + * {
                margin-top: 0.75rem !important;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .chat-container {
                height: 80vh !important;
                max-height: 800px !important;
            }
            
            .message-bubble-tablet {
                max-width: 80% !important;
            }
            
            /* Better spacing for tablets */
            .space-y-4 > * + * {
                margin-top: 1rem !important;
            }
        }

        @media (min-width: 1025px) {
            .chat-container {
                height: 85vh !important;
                max-height: 900px !important;
            }
            
            .message-bubble-desktop {
                max-width: 75% !important;
            }
            
            /* Enhanced desktop spacing */
            .space-y-4 > * + * {
                margin-top: 1.25rem !important;
            }
        }

        /* Touch-friendly buttons for mobile */
        @media (max-width: 640px) {
            button {
                min-height: 44px; /* iOS touch target minimum */
            }
            
            .option-btn-mobile {
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
                min-height: 44px !important;
            }
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 sm:p-6 lg:p-8 transition-colors duration-300">
    <div class="w-full max-w-6xl mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-700 flex flex-col transition-colors duration-300"
            style="height: 85vh; max-height: 900px;">

            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between header-mobile">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-white/20 rounded-full flex items-center justify-center text-lg sm:text-2xl">
                        🤖
                    </div>
                    <div>
                        <h1 class="text-white font-semibold text-sm sm:text-lg header-title">Botpress Assistant</h1>
                        <p class="text-indigo-100 text-xs header-subtitle" id="statusText">Connecting...</p>
                    </div>
                </div>
                <button id="themeToggle"
                    class="w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-white/20 hover:bg-white/30 transition-colors flex items-center justify-center text-white text-base sm:text-lg"
                    aria-label="Toggle theme">
                    🌙
                </button>
            </div>

            <!-- Status Bar -->
            <div id="status"
                class="px-4 sm:px-6 py-2 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 status-mobile">
                <div class="flex items-center gap-2 text-xs sm:text-sm text-gray-600 dark:text-gray-400">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span>Initializing connection...</span>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="chatMessages"
                class="flex-1 overflow-y-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6 space-y-4 bg-gray-50/50 dark:bg-gray-900/50 messages-mobile">
                <!-- Messages will appear here -->
            </div>

            <!-- Input Container -->
            <div class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 sm:px-6 py-4">
                <div class="flex gap-3">
                    <input type="text" id="messageInput" placeholder="Type your message..."
                        class="flex-1 px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 focus:border-transparent transition-all" />
                    <button id="sendBtn"
                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-medium rounded-xl transition-all transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                        <span class="hidden sm:inline">Send</span>
                        <span class="sm:hidden">📤</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');

        // Theme setup
        (function setupTheme() {
            const body = document.body;
            const saved = localStorage.getItem('theme') || 'light';

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    body.style.background = '#0f172a';
                } else {
                    document.documentElement.classList.remove('dark');
                    body.style.background = 'linear-gradient(135deg, rgb(238 242 255) 0%, rgb(255 255 255) 50%, rgb(250 245 255) 100%)';
                }
            }

            applyTheme(saved);

            const btn = document.getElementById('themeToggle');
            const updateIcon = () => {
                btn.textContent = document.documentElement.classList.contains('dark') ? '☀️' : '🌙';
            };
            updateIcon();

            btn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                const newTheme = isDark ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
                updateIcon();
            });
        })();

        async function initializeChat() {
            const seenMessageIds = new Set();

            async function pollMessages() {
                try {
                    const res = await fetch(`${API_URL}/api/get-messages`);
                    if (!res.ok) throw new Error('Failed to fetch messages');
                    const { data } = await res.json();

                    const messages = Array.isArray(data?.messages) ? data.messages : (Array.isArray(data) ? data : []);
                    for (const msg of messages) {
                        if (!msg || !msg.id || seenMessageIds.has(msg.id)) continue;
                        seenMessageIds.add(msg.id);
                        if (msg.payload && msg.payload.type === 'text' && msg.direction !== 'outgoing') {
                            addBotMessage(msg.payload);
                        }
                    }

                    status.innerHTML = `
                        <div class="flex items-center gap-2 text-sm text-green-600 dark:text-green-400">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span>Connected</span>
                        </div>
                    `;
                    statusText.textContent = 'Online';
                } catch (err) {
                    console.error('Polling error:', err);
                    status.innerHTML = `
                        <div class="flex items-center gap-2 text-sm text-red-600 dark:text-red-400">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                            <span>Disconnected</span>
                        </div>
                    `;
                    statusText.textContent = 'Offline';
                }
            }

            await pollMessages();
            setInterval(pollMessages, 2000);

            async function sendMessage(text) {
                if (!text.trim()) return;

                addUserMessage(text);
                messageInput.value = '';

                try {
                    const response = await fetch(`${API_URL}/api/send-message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }
                } catch (error) {
                    console.error('Send error:', error);
                    addSystemMessage('Failed to send message. Please try again.');
                }
            }

            function addUserMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message flex justify-end';
                messageDiv.innerHTML = `
                    <div class="max-w-[85%] sm:max-w-[75%] lg:max-w-[70%] px-4 py-3 rounded-2xl rounded-br-sm bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-md">
                        <p class="text-sm sm:text-base leading-relaxed">${escapeHtml(text)}</p>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
            }

            function addBotMessage(payload) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message w-full';

                const bubble = document.createElement('div');
                bubble.className = 'w-full px-4 py-3 bg-transparent text-gray-900 dark:text-gray-100';

                renderTextAndCode(bubble, payload.text || '');

                if (payload.type === 'choice' && payload.options) {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'flex flex-col gap-2 mt-3';

                    payload.options.forEach(option => {
                        const btn = document.createElement('button');
                        btn.className = 'px-4 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-700 rounded-lg transition-colors';
                        btn.textContent = option.label;
                        btn.onclick = () => sendMessage(option.value);
                        optionsDiv.appendChild(btn);
                    });

                    bubble.appendChild(optionsDiv);
                }

                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
            }

            function renderTextAndCode(container, text) {
                if (!text) return;

                const segments = [];
                const regex = /```[ \t]*([\w+-]*)[ \t]*\r?\n([\s\S]*?)```/g;
                let lastIndex = 0;
                let match;

                while ((match = regex.exec(text)) !== null) {
                    const [full, langRaw, code] = match;
                    const lang = (langRaw || '').toLowerCase();
                    if (match.index > lastIndex) {
                        segments.push({ type: 'text', content: text.slice(lastIndex, match.index) });
                    }
                    segments.push({ type: 'code', lang, content: code });
                    lastIndex = match.index + full.length;
                }

                if (lastIndex < text.length) {
                    segments.push({ type: 'text', content: text.slice(lastIndex) });
                }

                for (const seg of segments) {
                    if (seg.type === 'text') {
                        const textContent = seg.content.trim();
                        if (textContent) {
                            // Check if the text starts with ** (heading)
                            if (textContent.startsWith('**') && textContent.includes('**', 2)) {
                                const p = document.createElement('div');
                                p.className = 'text-sm sm:text-base leading-relaxed';
                                renderInlineCode(p, textContent);
                                if (p.textContent || p.childNodes.length) container.appendChild(p);
                            } else {
                                const p = document.createElement('div');
                                p.className = 'text-sm sm:text-base leading-relaxed';
                                renderInlineCode(p, textContent);
                                if (p.textContent || p.childNodes.length) container.appendChild(p);
                            }
                        }
                    } else if (seg.type === 'code') {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'relative mt-3 rounded-lg overflow-hidden bg-[#1d1f21] shadow-lg';

                        // Header with language label and copy button
                        const header = document.createElement('div');
                        header.className = 'flex items-center justify-between px-4 py-2.5 bg-[#282a2e] border-b border-[#373b41]';

                        const label = document.createElement('div');
                        label.className = 'text-xs font-semibold text-gray-300 uppercase tracking-wide';
                        label.textContent = seg.lang || 'plaintext';

                        const btn = document.createElement('button');
                        btn.className = 'px-3 py-1 text-xs text-gray-300 hover:text-white hover:bg-[#373b41] rounded transition-all flex items-center gap-1.5';
                        btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>';

                        header.appendChild(label);
                        header.appendChild(btn);
                        wrapper.appendChild(header);

                        // Code block with syntax highlighting using Prism
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');

                        const cleanCode = seg.content.replace(/^\n+|\n+$/g, '');
                        code.textContent = cleanCode;

                        // Map common language aliases to Prism language names
                        const languageMap = {
                            'js': 'javascript',
                            'jsx': 'jsx',
                            'ts': 'typescript',
                            'tsx': 'typescript',
                            'py': 'python',
                            'html': 'markup',
                            'xml': 'markup',
                            'sh': 'bash',
                            'shell': 'bash'
                        };

                        const langName = languageMap[seg.lang] || seg.lang || 'javascript';

                        // Apply language class for Prism
                        code.className = `language-${langName}`;
                        pre.className = 'code-block';

                        pre.appendChild(code);

                        // Apply Prism syntax highlighting
                        if (window.Prism) {
                            Prism.highlightElement(code);
                        }

                        // Copy button functionality
                        btn.addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(cleanCode);
                                btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copied!</span>';
                                btn.classList.add('text-green-400');
                                setTimeout(() => {
                                    btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>Copy</span>';
                                    btn.classList.remove('text-green-400');
                                }, 1200);
                            } catch (_) { }
                        });

                        wrapper.appendChild(pre);
                        container.appendChild(wrapper);
                    }
                }
            }

            function renderInlineCode(parent, text) {
                const parts = [];
                const inline = /`([^`]+)`/g;
                let last = 0;
                let m;
                while ((m = inline.exec(text)) !== null) {
                    if (m.index > last) parts.push({ t: 'text', v: text.slice(last, m.index) });
                    parts.push({ t: 'code', v: m[1] });
                    last = m.index + m[0].length;
                }
                if (last < text.length) parts.push({ t: 'text', v: text.slice(last) });

                if (parts.length === 0) {
                    applyBoldFormatting(parent, text);
                    return;
                }
                for (const p of parts) {
                    if (p.t === 'text') {
                        applyBoldFormatting(parent, p.v);
                    } else {
                        const code = document.createElement('code');
                        code.className = 'inline-code px-1.5 py-0.5 text-xs sm:text-sm bg-gray-100 dark:bg-gray-800 text-indigo-600 dark:text-indigo-400 rounded';
                        code.textContent = p.v;
                        parent.appendChild(code);
                    }
                }
            }

            function applyBoldFormatting(parent, text) {
                const regex = /(\*\*[^*]+\*\*)/g;
                let last = 0;
                let match;
                while ((match = regex.exec(text)) !== null) {
                    if (match.index > last) {
                        const beforeText = text.slice(last, match.index);
                        if (beforeText.trim()) {
                            parent.appendChild(document.createTextNode(beforeText));
                        }
                    }
                    const content = match[0].slice(2, -2);
                    const heading = document.createElement('h3');
                    heading.className = 'font-bold text-lg text-gray-900 dark:text-gray-100 mt-4 mb-2 first:mt-0';
                    heading.textContent = content;
                    parent.appendChild(heading);
                    last = match.index + match[0].length;
                }
                if (last < text.length) {
                    const remainingText = text.slice(last);
                    if (remainingText.trim()) {
                        parent.appendChild(document.createTextNode(remainingText));
                    }
                }
            }

            function addSystemMessage(text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message flex justify-center';
                messageDiv.innerHTML = `
                    <div class="px-4 py-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm border border-red-200 dark:border-red-800">
                        ${escapeHtml(text)}
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage(messageInput.value);
            });

            messageInput.focus();
        }

        initializeChat();
    </script>
</body>

</html>